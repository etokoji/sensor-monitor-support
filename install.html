<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>EtoTHSensorMonitor インストール</title>
        <style>
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                max-width: 600px;
                margin: 50px auto;
                padding: 20px;
                text-align: center;
                background-color: #f8f9fa;
            }
            .app-icon {
                width: 120px;
                height: 120px;
                border-radius: 20px;
                margin: 20px auto;
                display: block;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }
            .install-button {
                display: inline-block;
                background-color: #007aff;
                color: white;
                padding: 15px 30px;
                text-decoration: none;
                border-radius: 8px;
                font-size: 18px;
                margin: 20px 0;
                transition: all 0.3s ease;
            }
            .install-button:hover {
                background-color: #0051d0;
                transform: translateY(-1px);
            }
            .install-button:active {
                transform: translateY(0);
            }
            .info {
                background-color: white;
                padding: 20px;
                border-radius: 12px;
                margin: 20px 0;
                text-align: left;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            .status-message {
                padding: 15px;
                border-radius: 8px;
                margin: 20px 0;
                font-weight: 500;
                display: none;
            }
            .status-success {
                background-color: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            .status-installing {
                background-color: #d1ecf1;
                color: #0c5460;
                border: 1px solid #bee5eb;
            }
            .loading-spinner {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid #007aff;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-right: 10px;
                vertical-align: middle;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            /* iPad対応のCSS */
            @media screen and (min-width: 768px) {
                body {
                    max-width: 800px;
                    margin: 100px auto;
                }
                .app-icon {
                    width: 150px;
                    height: 150px;
                }
                .install-button {
                    font-size: 20px;
                    padding: 20px 40px;
                }
                h1 {
                    font-size: 2.5rem;
                }
            }
        </style>
    </head>
    <body>
        <img src="web_icons/icon_1024x1024_512x512.png" alt="EtoTHSensorMonitor" class="app-icon">
        <h1>EtoTHSensorMonitor</h1>
        <p>iOS向け環境センサー監視アプリ</p>

        <div id="installStatus" class="status-message"></div>

        <a
            href="itms-services://?action=download-manifest&url=https://etokoji.github.io/sensor-monitor-support/manifest.plist"
            class="install-button"
            id="installButton"
            onclick="handleInstallClick()"
        >
            アプリをインストール
        </a>

        <div class="info">
            <h3>📱 インストール手順：</h3>
            <ol>
                <li>上記の「アプリをインストール」ボタンをタップ</li>
                <li>「インストール」をタップして確認</li>
                <li>ダウンロード完了を待つ（数分かかる場合があります）</li>
                <li>ホーム画面にアプリアイコンが表示されたらタップ</li>
                <li>初回起動時は「信頼されていない開発者」エラーが出たら：<br>
                    設定 > 一般 > VPNとデバイス管理 > プロファイルを信頼</li>
            </ol>

            <h3>ℹ️ アプリ情報：</h3>
            <ul>
                <li>バージョン: 1.0</li>
                <li>Bundle ID: com.etokoji.EtoTHSensorMonitor</li>
                <li>対応OS: iOS 14.0以上</li>
                <li>温度・湿度・気圧データをリアルタイム表示</li>
                <li>Bluetooth・WiFi対応</li>
            </ul>

            <h3>⚠️ 注意事項：</h3>
            <ul>
                <li>iOSデバイスでのみインストール可能です</li>
                <li>初回起動時は「信頼されていない開発者」の設定が必要です</li>
                <li>カスタムファームウェア対応のESP32デバイスが必要です</li>
            </ul>
        </div>

        <script>
            function handleInstallClick() {
                const statusDiv = document.getElementById('installStatus');
                const button = document.getElementById('installButton');
                
                // インストール開始の表示
                statusDiv.innerHTML = '<span class="loading-spinner"></span>アプリのダウンロードを開始しています...';
                statusDiv.className = 'status-message status-installing';
                statusDiv.style.display = 'block';
                
                button.style.opacity = '0.6';
                button.style.pointerEvents = 'none';
                
                // 3秒後にダウンロード中メッセージを表示
                setTimeout(() => {
                    statusDiv.innerHTML = '<span class="loading-spinner"></span>ダウンロード中... しばらくお待ちください';
                }, 3000);
                
                // 8秒後に完了メッセージを表示
                setTimeout(() => {
                    statusDiv.innerHTML = '✅ ダウンロードが完了しました！<br>📱 ホーム画面でアプリアイコンをタップしてアプリを起動してください';
                    statusDiv.className = 'status-message status-success';
                    
                    button.innerHTML = '🔄 再インストール';
                    button.href = 'itms-services://?action=download-manifest&url=https://etokoji.github.io/sensor-monitor-support/manifest.plist';
                    button.style.opacity = '1';
                    button.style.pointerEvents = 'auto';
                    button.style.backgroundColor = '#6c757d';
                    button.onclick = null; // 元のクリックハンドラーを削除
                }, 8000);
                
                // アプリが既にインストールされているかチェック
                setTimeout(() => {
                    checkIfAppInstalled();
                }, 10000);
            }
            
            function checkIfAppInstalled() {
                // フォーカスイベントでアプリの起動を検出
                let hidden = false;
                
                const handleVisibilityChange = () => {
                    if (document.hidden) {
                        hidden = true;
                    } else if (hidden) {
                        // アプリから戻ってきた場合
                        const statusDiv = document.getElementById('installStatus');
                        statusDiv.innerHTML = '🎉 アプリが正常に起動しました！インストール完了です。';
                        statusDiv.className = 'status-message status-success';
                    }
                };
                
                document.addEventListener('visibilitychange', handleVisibilityChange);
            }
            
            // ページ読み込み時に実行
            document.addEventListener('DOMContentLoaded', function() {
                // デバッグ情報を表示
                console.log('📱 User Agent:', navigator.userAgent);
                console.log('🖥️ Platform:', navigator.platform);
                console.log('👆 Max touch points:', navigator.maxTouchPoints);
                console.log('📐 Screen size:', screen.width + 'x' + screen.height);
                
                // userAgentチェックを無効化 - すべてのデバイスでインストールボタンを表示
                console.log('✅ インストールボタンを表示します（userAgentチェック無効）');
                
                const statusDiv = document.getElementById('installStatus');
                statusDiv.innerHTML = '📱 iOS/iPadOSデバイスで「アプリをインストール」ボタンをタップしてください';
                statusDiv.className = 'status-message';
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#e7f3ff';
                statusDiv.style.color = '#0c5460';
                statusDiv.style.border = '1px solid #bee5eb';
            });
        </script>
    </body>
</html>
